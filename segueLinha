using System;
using System.Device.Gpio;
using System.Diagnostics;
using System.Threading;
using System.Device.Adc;

GpioController gpio = new GpioController();

AdcController adc = new AdcController();

AdcChannel sensorEsq = adc.OpenChannel(6);
AdcChannel sensorCen = adc.OpenChannel(7);
AdcChannel sensorDir = adc.OpenChannel(3);

GpioPin mEsq1 = gpio.OpenPin(33, PinMode.Output);
GpioPin mEsq2 = gpio.OpenPin(27, PinMode.Output);
GpioPin mDir1 = gpio.OpenPin(4, PinMode.Output);
GpioPin mDir2 = gpio.OpenPin(2, PinMode.Output);

int velReta = 200, velCurva = 400, corte = 2000;

//Array para armazenar as leituras dos sensores
string[] ls = new string[3];
bool[] polaridades = new bool[3];//Polaridades dos sensores, 0 maior número indica branco, 1 maior número indica preto
string estado = "!", estadoAnterior = "!";

polaridades[0] = true;
polaridades[1] = false;
polaridades[2] = true;

while (true)
{
    lopenFrente(2000);
    Thread.Sleep(5000);
}

void lerSensores()
{
    ls[0] = definirCor(sensorEsq.ReadValue(), 0);
    ls[1] = definirCor(sensorCen.ReadValue(), 1);
    ls[2] = definirCor(sensorDir.ReadValue(), 2);

    estado = definirEstado();

    Console.WriteLine($"Esquerda: {ls[0]} | Centro: {ls[1]} | Direita: {sensorDir.ReadValue()} | Estado: {estado}");
}

string definirCor(int input, int indice)
{
    if (input < corte)
    {
        if (polaridades[indice]) return "Branco";
        else return "Preto";
    }
    else
    {
        if (polaridades[indice]) return "Preto";
        else return "Branco";
    }
}

string definirEstado()
{
    if (ls[0] == "Preto" && ls[1] == "Preto" && ls[2] == "Preto")
    {
        return "cruz";
    }
    else if (ls[1] == "Branco")
    {
        if (ls[0] == "Preto") return "corrigirEsq";
        else if (ls[2] == "Preto") return "corrigirDir";
        else return estadoAnterior;
    }
    else if (ls[1] == "Preto")
    {
        if (ls[0] == "Preto") return "90Esq";
        else if (ls[2] == "Preto") return "90Dir";
        else return estadoAnterior;
    }
    else return estado;
   // estadoAnterior = estado;

}

void seguirLinha()
{
    if (estado == "cruz")
    {
        lopenFrente(1000);
    }
    else if (estado == "90Esq")
    {
        lopenEsq(500);
    }
    else if (estado == "90Dir")
    {
        lopenDir(500);
    }
    else if (estado == "corrigirEsq")
    {
        lopenEsq(200);
    }
    else if (estado == "corrigirDir")
    {
        lopenDir(200);
    }
    else if (estado == "gap")
    {
        lopenFrente(500);
    }
}

void lopenFrente(int time)
{
    mEsq1.Write(velReta);
    mEsq2.Write(PinValue.Low);
    mDir1.Write(velReta);
    mDir2.Write(PinValue.Low);
    Thread.Sleep(time);
    parar();
}

void lopenTras(int time)
{
    mEsq1.Write(PinValue.Low);
    mEsq2.Write(velReta);
    mDir1.Write(PinValue.Low);
    mDir2.Write(velReta);
    Thread.Sleep(time);
    parar();
}

void lopenDir(int time)
{
    mEsq1.Write(velCurva);
    mEsq2.Write(PinValue.Low);
    mDir1.Write(PinValue.Low);
    mDir2.Write(velCurva);
    Thread.Sleep(time);
    parar();
}

void lopenEsq(int time)
{
    mEsq1.Write(PinValue.Low);
    mEsq2.Write(velCurva);
    mDir1.Write(velCurva);
    mDir2.Write(PinValue.Low);
    Thread.Sleep(time);
    parar();
}

void parar()
{
    mEsq1.Write(PinValue.Low);
    mEsq2.Write(PinValue.Low);
    mDir1.Write(PinValue.Low);
    mDir2.Write(PinValue.Low);
}
